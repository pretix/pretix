{% extends "pretixcontrol/event/base.html" %}
{% load i18n %}
{% load eventurl %}
{% load bootstrap3 %}
{% load static %}
{% load escapejson %}
{% load eventsignal %}
{% block title %}{{ request.event.name }}{% endblock %}
{% block content %}
    <div class="row">
    <div id="header-area" class="col-lg-8">
        <h1>
            {{ request.event.name }}
            <small>
                {% if request.event.has_subevents %}
                    {% trans "Event series" %}
                {% else %}
                    {{ request.event.get_date_range_display }}
                {% endif %}
            </small>
        </h1>

        <div class="helper-space-below">
            {% trans "Shop URL:" %}
            <span id="shop_url" class="text-muted">{% abseventurl request.event "presale:event.index" %}</span>
            <button type="button" class="btn btn-default btn-xs btn-clipboard js-only" data-clipboard-target="#shop_url">
                <i class="fa fa-clipboard" aria-hidden="true"></i>
                <span class="sr-only">{% trans "Copy to clipboard" %}</span>
            </button>
            <div class="btn-group helper-display-inline-block">
                <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" title="{% trans "Create QR code" %}" aria-haspopup="true" aria-expanded="false">
                    <i class="fa fa-qrcode" aria-hidden="true"></i>
                </button>
                {% include "pretixcontrol/event/fragment_qr_dropdown.html" with url=0 %}
            </div>
            <br>
            <span id="shop_state" class="shop_state">
                {{ shop_state.content|safe }}
                <a href="{{ shop_state.url }}">
                    <button type="button" class="btn btn-default btn-xs btn-wrench js-only" href="{{ shop_state.url }}">
                        <i class="fa fa-wrench" aria-hidden="true"></i>
                        <span class="sr-only">{% trans "Change shop state" %}</span>
                    </button>
                </a>
            </span>
            <div class="clearfix"></div>
        </div>
    </div>
    <!-- Comments ----------------------------------------------------------------------------------------------------->
    <div class="event-comment col-lg-4">
        {% trans "Internal comment" %}
        <form class="form" method="post"
              action="{% url "control:event.comment" event=request.event.slug organizer=request.event.organizer.slug %}">
            {% csrf_token %}
            <div class="row">
                {% bootstrap_field comment_form.comment layout="horizontal" show_help=True show_label=False horizontal_field_class="col-md-12" %}
            </div>
            {% if not comment_form.readonly %}
                <p class="text-right flip">
                    <button class="btn btn-default">
                        {% trans "Update comment" %}
                    </button>
                </p>
            {% endif %}
        </form>
    </div>
    </div>
    <!-- Comments ----------------------------------------------------------------------------------------------------->

    <!-- Warnings ----------------------------------------------------------------------------------------------------->
    <div class="row-form-errors">
    {% if has_overpaid_orders %}
        <div class="alert alert-warning">
            {% blocktrans trimmed %}
                This event contains <strong>overpaid orders</strong>, for example due to duplicate payment attempts.
                You should review the cases and consider refunding the overpaid amount to the user.
            {% endblocktrans %}
            <a href="{% url "control:event.orders" event=request.event.slug organizer=request.event.organizer.slug %}?status=overpaid"
                    class="btn btn-primary">{% trans "Show overpaid orders" %}</a>
        </div>
    {% endif %}
    {% if has_pending_refunds %}
        <div class="alert alert-warning">
            {% blocktrans trimmed %}
                This event contains <strong>pending refunds</strong> that you should take care of.
            {% endblocktrans %}
            <a href="{% url "control:event.orders.refunds" event=request.event.slug organizer=request.event.organizer.slug %}"
                    class="btn btn-primary">{% trans "Show pending refunds" %}</a>
        </div>
    {% endif %}
    {% if has_cancellation_requests %}
        <div class="alert alert-warning">
            {% blocktrans trimmed %}
                This event contains <strong>requested cancellations</strong> that you should take care of.
            {% endblocktrans %}
            <a href="{% url "control:event.orders" event=request.event.slug organizer=request.event.organizer.slug %}?status=rc"
                    class="btn btn-primary">{% trans "Show orders requesting cancellation" %}</a>
        </div>
    {% endif %}
    {% if has_pending_approvals %}
        <div class="alert alert-warning">
            {% blocktrans trimmed %}
                This event contains <strong>pending approvals</strong> that you should take care of.
            {% endblocktrans %}
            <a href="{% url "control:event.orders" event=request.event.slug organizer=request.event.organizer.slug %}?status=pa"
                    class="btn btn-primary">{% trans "Show orders pending approval" %}</a>
        </div>
    {% endif %}
    {% if has_pending_orders_with_full_payment %}
        <div class="alert alert-warning">
            {% blocktrans trimmed %}
                This event contains <strong>fully paid orders</strong> that are not marked as paid, probably
                because no quota was left at the time their payment arrived. You should review the cases and consider
                either refunding the customer or creating more space.
            {% endblocktrans %}
            <a href="{% url "control:event.orders" event=request.event.slug organizer=request.event.organizer.slug %}?status=pendingpaid"
               class="btn btn-primary">{% trans "Show affected orders" %}</a>
        </div>
    {% endif %}
    </div>
    <!-- Warnings ----------------------------------------------------------------------------------------------------->

    {% eventsignal request.event "pretix.control.signals.event_dashboard_top" request=request %}
    <!-- Timeline ----------------------------------------------------------------------------------------------------->
    {% if request.event.has_subevents %}
        <form class="form-inline helper-display-inline" action="" method="get">
            {% include "pretixcontrol/event/fragment_subevent_choice_simple.html" %}
        </form>
    {% endif %}
    {% if not request.event.has_subevents or subevent %}
        {% include "pretixcontrol/event/fragment_timeline.html" %}
    {% endif %}
    <!-- Timeline ----------------------------------------------------------------------------------------------------->
    <!-- Big numbers ---------------------------------------------------------------------------------------------->
    <div class="dashboard">
        <div class="widget-container widget-small event-dashboard">
            <a href="{{ attendees_paid_ordered.url }}" class="widget">
                {{ attendees_paid_ordered.content|safe }}
            </a>
        </div>
        <div class="widget-container widget-small event-dashboard">
            <a href="{{ total_revenue.url }}" class="widget">
                {{ total_revenue.content|safe }}
            </a>
        </div>
    </div>
    <!-- Big numbers -------------------------------------------------------------------------------------------------->
    <!-- Diagram ------------------------------------------------------------------------------------------------------>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">{% trans "Revenue over time" %}</h3>
        </div>
        <div class="panel-body">
            <div id="rev_chart" class="chart"></div>
            {% if request.GET.subevent %}
                <div class="alert alert-info">
                    {% blocktrans trimmed context "subevent" %}
                        If you select a single date, payment method fees will not be listed here as it might not be clear which
                        date they belong to.
                    {% endblocktrans %}
                </div>
            {% endif %}
            <p class="help-block">
                <small>
                    {% blocktrans trimmed %}
                        Only fully paid orders are counted.
                        Orders paid in multiple payments are shown with the date of their last payment.
                    {% endblocktrans %}
                </small>
            </p>
        </div>
    </div>
    <!-- Diagram ------------------------------------------------------------------------------------------------------>
    <!-- Check-Ins ---------------------------------------------------------------------------------------------------->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">{% trans "Check-In" %}</h3>
        </div>
        <div class="table-responsive">
            <table class="table table-hover table-quotas">
                <thead>
                <tr>
                    <th>
                        {% trans "Name" %}
                    </th>
                    <th>{% trans "Checked in" %}</th>
                    {% if request.event.has_subevents %}
                        <th>
                            {% trans "Date" context "subevent" %}
                        </th>
                    {% endif %}
                    <th class="iconcol">{% trans "Automated check-in" %}</th>
                    <th>{% trans "Products" %}</th>
                    <th class="action-col-2"></th>
                </tr>
                </thead>
                <tbody>
                {% for cl in checkinlists %}
                    <tr>
                        <td>
                            <strong><a
                                    href="{% url "control:event.orders.checkinlists.show" organizer=request.event.organizer.slug event=request.event.slug list=cl.id %}">{{ cl.name }}</a></strong>
                        </td>
                        <td>
                            <div class="quotabox availability">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-success progress-bar-{{ cl.percent }}">
                                    </div>
                                </div>
                                <div class="numbers">
                                    {{ cl.checkin_count|default_if_none:"0" }} /
                                    {{ cl.position_count|default_if_none:"0" }}
                                </div>
                            </div>
                        </td>
                        {% if request.event.has_subevents %}
                            {% if cl.subevent %}
                                <td>
                                    {{ cl.subevent.name }} – {{ cl.subevent.get_date_range_display }}
                                    {{ cl.subevent.date_from|date:"TIME_FORMAT" }}
                                </td>
                            {% else %}
                                <td>
                                    <em>{% trans "All" %}</em>
                                </td>
                            {% endif %}
                        {% endif %}
                        <td>
                            {% for channel in cl.auto_checkin_sales_channels %}
                                <span class="fa fa-{{ channel.icon }} text-muted"
                                      data-toggle="tooltip" title="{% trans channel.verbose_name %}"></span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if cl.all_products %}
                                <em>{% trans "All" %}</em>
                            {% else %}
                                <ul>
                                    {% for item in cl.limit_products.all %}
                                        <li>
                                            <a href="{% url "control:event.item" organizer=request.event.organizer.slug event=request.event.slug item=item.id %}">{{ item }}</a>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </td>
                        <td class="text-right flip">
                            <a href="{% url "control:event.orders.checkinlists.show" organizer=request.event.organizer.slug event=request.event.slug list=cl.id %}"
                               class="btn btn-default btn-sm"><i class="fa fa-eye"></i></a>
                            {% if "can_change_event_settings" in request.eventpermset %}
                                <a href="{% url "control:event.orders.checkinlists.add" organizer=request.event.organizer.slug event=request.event.slug %}?copy_from={{ cl.id }}"
                                   class="btn btn-sm btn-default" title="{% trans "Clone" %}" data-toggle="tooltip">
                                    <span class="fa fa-copy"></span>
                                </a>
                                <a href="{% url "control:event.orders.checkinlists.simulator" organizer=request.event.organizer.slug event=request.event.slug list=cl.id %}"
                                   title="{% trans "Check-in simulator" %}" data-toggle="tooltip"
                                   class="btn btn-default btn-sm"><i class="fa fa-flask"></i></a>
                                <a href="{% url "control:event.orders.checkinlists.edit" organizer=request.event.organizer.slug event=request.event.slug list=cl.id %}"
                                   class="btn btn-default btn-sm"><i class="fa fa-wrench"></i></a>
                                <a href="{% url "control:event.orders.checkinlists.delete" organizer=request.event.organizer.slug event=request.event.slug list=cl.id %}"
                                   class="btn btn-danger btn-sm"><i class="fa fa-trash"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- Check-Ins ---------------------------------------------------------------------------------------------------->
    <!-- Quotas ------------------------------------------------------------------------------------------------------->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">{% trans "Quotas" %}</h3>
        </div>
        <div class="table-responsive table-quotas">
            <table class="table table-hover table-quotas">
                <thead>
                    <tr>
                        <th>
                            {% trans "Name" %}
                        </th>
                        <th>
                            {% trans "Begin" %}
                            <a href="? url_replace request 'filter-ordering' '-date_from' %}"><i class="fa fa-caret-down"></i></a>
                            <a href="? url_replace request 'filter-ordering' 'date_from' %}"><i class="fa fa-caret-up"></i></a>
                        </th>
                        <th>
                            {% trans "Paid tickets per quota" %}
                        </th>
                        <th>
                            {% trans "Capacity left" %}
                        </th>
                    </tr>
                </thead>
                <tbody>
                {% if request.event.has_subevents and not subevent %}
                    {% for s in subevents %}
                        <tr>
                            <td>
                                <strong><a href="{% url "control:event.subevent" organizer=request.event.organizer.slug event=request.event.slug subevent=s.id %}?returnto={{ request.GET.urlencode|urlencode }}">
                                    {{ s.name }}</a></strong><br>
                                <small class="text-muted">
                                    #{{ s.pk }}
                                </small>
                            </td>
                            <td>
                                {{ s.get_date_from_display }}<br>
                                <span class="text-muted">
                                   {{ s.date_from|date:"l" }}
                                </span>
                            </td>
                            <td>
                                {% for q in s.first_quotas|slice:":3" %}
                                    {% include "pretixcontrol/fragment_quota_box_paid.html" with quota=q %}
                                {% endfor %}
                                {% if s.first_quotas|length > 3 %}
                                    <a href="{% url "control:event.items.quotas" organizer=request.event.organizer.slug event=request.event.slug %}?subevent={{ s.id }}"
                                            class="quotabox-more" data-toggle="tooltip" title="{% trans "More quotas" %}"
                                            data-placement="top">
                                        &middot;&middot;&middot;
                                    </a>
                                {% endif %}
                            </td>
                            <td>
                                {% for q in s.first_quotas %}
                                {% include "pretixcontrol/items/fragment_quota_availability.html" with availability=q.cached_avail closed=q.closed %}
                                {% endfor %}
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
                {% if subevent %}
                    <tr>
                        <td>
                            <strong><a href="{% url "control:event.subevent" organizer=request.event.organizer.slug event=request.event.slug subevent=subevent.id %}?returnto={{ request.GET.urlencode|urlencode }}">
                                {{ subevent.name }}</a></strong><br>
                            <small class="text-muted">
                                #{{ subevent.pk }}
                            </small>
                        </td>
                        <td>
                            {{ subevent.get_date_from_display }}<br>
                            <span class="text-muted">
                               {{ subevent.date_from|date:"l" }}
                            </span>
                        </td>
                        <td>
                            {% for q in subevent.first_quotas|slice:":3" %}
                                {% include "pretixcontrol/fragment_quota_box_paid.html" with quota=q %}
                            {% endfor %}
                            {% if subevent.first_quotas|length > 3 %}
                                <a href="{% url "control:event.items.quotas" organizer=request.event.organizer.slug event=request.event.slug %}?subevent={{ subevent.id }}"
                                        class="quotabox-more" data-toggle="tooltip" title="{% trans "More quotas" %}"
                                        data-placement="top">
                                    &middot;&middot;&middot;
                                </a>
                            {% endif %}
                        </td>
                        <td>
                            {% for q in subevent.first_quotas %}
                            {% include "pretixcontrol/items/fragment_quota_availability.html" with availability=q.cached_avail closed=q.closed %}
                            {% endfor %}
                        </td>
                    </tr>
                {% endif %}
                </tbody>
                </table>
        </div>
    </div>
    <!-- Quotas ------------------------------------------------------------------------------------------------------->
    <!-- Logs --------------------------------------------------------------------------------------------------------->
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                {% trans "Event logs" %}
            </h3>
        </div>
        <ul class="list-group" id="logs_target">
            <div class="logs-lazy-loading">
                <span class="fa fa-cog fa-4x"></span>
            </div>
        </ul>
        <div class="panel-footer">
            <a href="{% url "control:event.log" event=request.event.slug organizer=request.event.organizer.slug %}">
                {% trans "Show more logs" %}
            </a>
        </div>
    </div>
    <!-- Logs --------------------------------------------------------------------------------------------------------->
    <script type="application/json" id="rev-data">{{ rev_data|escapejson }}</script>
    <script type="application/text" id="currency">{{ request.event.currency }}</script>
{% endblock %}
